<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Section Player - TTS Integration Demo</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
			background: #f5f5f5;
		}

		h1 {
			color: #333;
			margin-bottom: 0.5rem;
		}

		.demo-header {
			margin-bottom: 2rem;
			padding: 1rem;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.demo-header .badge {
			display: inline-block;
			padding: 0.25rem 0.75rem;
			background: #4caf50;
			color: white;
			border-radius: 12px;
			font-size: 0.85rem;
			font-weight: 600;
			margin-left: 1rem;
		}

		.controls {
			margin-bottom: 2rem;
			padding: 1rem;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.controls h2 {
			margin-top: 0;
			font-size: 1.2rem;
			color: #555;
		}

		.button-group {
			display: flex;
			gap: 1rem;
			margin-bottom: 1rem;
		}

		button {
			padding: 0.5rem 1rem;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		button:hover {
			background: #0056b3;
		}

		button.secondary {
			background: #6c757d;
		}

		button.secondary:hover {
			background: #545b62;
		}

		button.tts {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}

		button.tts:hover {
			opacity: 0.9;
		}

		.player-container {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			padding: 1rem;
		}

		.info-box {
			margin-bottom: 1rem;
			padding: 1rem;
			background: #e3f2fd;
			border-left: 4px solid #2196f3;
			border-radius: 4px;
		}

		.info-box h3 {
			margin: 0 0 0.5rem 0;
			color: #1976d2;
			font-size: 1rem;
		}

		.info-box p {
			margin: 0;
			color: #424242;
			font-size: 0.9rem;
		}

		.info-box ul {
			margin: 0.5rem 0 0 1.5rem;
			padding: 0;
			color: #424242;
			font-size: 0.9rem;
		}

		.tts-status {
			padding: 0.75rem;
			background: #f5f5f5;
			border-radius: 4px;
			margin-bottom: 1rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.tts-status.ready {
			background: #e8f5e9;
			color: #2e7d32;
		}

		.tts-status.error {
			background: #ffebee;
			color: #c62828;
		}

		.tts-icon {
			font-size: 1.2rem;
		}

		.event-log {
			margin-top: 2rem;
			padding: 1rem;
			background: #f9f9f9;
			border: 1px solid #ddd;
			border-radius: 4px;
			max-height: 200px;
			overflow-y: auto;
		}

		.event-log h3 {
			margin-top: 0;
			font-size: 1rem;
			color: #555;
		}

		.event-log pre {
			margin: 0.5rem 0;
			padding: 0.5rem;
			background: white;
			border: 1px solid #e0e0e0;
			border-radius: 2px;
			font-size: 0.85rem;
			overflow-x: auto;
		}
	</style>
</head>
<body>
	<div class="demo-header">
		<h1>
			ü•ß PIE Section Player - TTS Integration Demo
			<span class="badge">NEW</span>
		</h1>
		<p>Demonstrates how the section player integrates with the Assessment Toolkit's TTS service.</p>
	</div>

	<div class="controls">
		<h2>TTS Controls</h2>

		<div id="tts-status" class="tts-status">
			<span class="tts-icon">‚è≥</span>
			<span>Initializing TTS service...</span>
		</div>

		<div class="info-box">
			<h3>üéØ How It Works</h3>
			<p>The section player now accepts TTS service integration with inline tool icons:</p>
			<ul>
				<li><strong>Real TTS Service:</strong> Using actual BrowserTTSProvider with Web Speech API - no mocks!</li>
				<li><strong>Service Passing:</strong> TTSService and ToolCoordinator are passed as JavaScript properties to the section player</li>
				<li><strong>Inline TTS Tools:</strong> TTS speaker icons (üîä) appear in passage and item headers when TTS service is available</li>
				<li><strong>Component Chain:</strong> Services flow through: SectionPlayer ‚Üí Layout ‚Üí ItemRenderer/PassageRenderer ‚Üí TTS Tool</li>
				<li><strong>Tool Registration:</strong> Each TTS tool registers with ToolCoordinator for lifecycle and visibility management</li>
				<li><strong>Catalog Support:</strong> Tools pass catalog IDs to TTSService for QTI 3.0 accessibility catalog resolution</li>
				<li><strong>Backward Compatible:</strong> All existing APIs remain unchanged - services are optional</li>
			</ul>
			<p><strong>Try it:</strong> Look for the speaker icons (üîä) in the passage and item headers below. Click them to hear real browser TTS!</p>
		</div>

		<div class="button-group">
			<button class="tts" onclick="testTTS()">
				<span>üîä</span>
				Test TTS
			</button>
			<button onclick="loadPageMode()">Page Mode (All Visible)</button>
			<button onclick="loadItemMode()">Item Mode (One at a Time)</button>
			<button class="secondary" onclick="clearLog()">Clear Event Log</button>
		</div>
	</div>

	<div class="player-container">
		<pie-section-player id="player"></pie-section-player>
	</div>

	<div class="event-log">
		<h3>Event Log</h3>
		<div id="log"></div>
	</div>

	<!-- Import assessment toolkit for TTS service -->
	<script type="module">
		// Import the section player web component
		import '../dist/pie-section-player.js';

		// Import real TTS service from assessment-toolkit
		import { TTSService, BrowserTTSProvider, ToolCoordinator, HighlightCoordinator } from '../../assessment-toolkit/dist/index.js';

		// Create real TTS service with browser provider
		const ttsService = new TTSService();

		// Wrap speak method to add logging
		const originalSpeak = ttsService.speak.bind(ttsService);
		ttsService.speak = async function(text, options = {}) {
			const source = options.catalogId?.startsWith('passage') ? 'passage' :
			               options.catalogId?.startsWith('item') ? 'item' : 'unknown';

			console.log('[TTS] Speaking:', {
				source,
				catalogId: options.catalogId,
				textLength: text.length,
				language: options.language
			});

			// Log to event viewer
			addLog('tts-triggered', {
				source,
				catalogId: options.catalogId || 'none',
				textPreview: text.substring(0, 50) + '...',
				language: options.language || 'en-US'
			});

			// Call original speak method (real browser TTS)
			return originalSpeak(text, options);
		};

		// Create real coordinators
		const toolCoordinator = new ToolCoordinator();
		const highlightCoordinator = new HighlightCoordinator();

		// Wrap coordinator methods to add logging
		const originalRegisterTool = toolCoordinator.registerTool.bind(toolCoordinator);
		toolCoordinator.registerTool = function(id, name, element, layer) {
			console.log('[ToolCoordinator] Registered tool:', id, name);
			addLog('tool-registered', { id, name, layer });
			return originalRegisterTool(id, name, element, layer);
		};

		const originalUnregisterTool = toolCoordinator.unregisterTool.bind(toolCoordinator);
		toolCoordinator.unregisterTool = function(id) {
			console.log('[ToolCoordinator] Unregistered tool:', id);
			addLog('tool-unregistered', { id });
			return originalUnregisterTool(id);
		};

		const originalShowTool = toolCoordinator.showTool.bind(toolCoordinator);
		toolCoordinator.showTool = function(id) {
			console.log('[ToolCoordinator] Show tool:', id);
			addLog('tool-shown', { id });
			return originalShowTool(id);
		};

		const originalHideTool = toolCoordinator.hideTool.bind(toolCoordinator);
		toolCoordinator.hideTool = function(id) {
			console.log('[ToolCoordinator] Hide tool:', id);
			addLog('tool-hidden', { id });
			return originalHideTool(id);
		};

		const player = document.getElementById('player');
		const log = document.getElementById('log');
		const statusEl = document.getElementById('tts-status');

		// Initialize TTS service with browser provider
		async function initializeTTS() {
			try {
				await ttsService.initialize(new BrowserTTSProvider());

				statusEl.className = 'tts-status ready';
				statusEl.innerHTML = '<span class="tts-icon">‚úÖ</span><span>TTS service ready (Browser API)</span>';

				addLog('tts-initialized', { provider: 'Browser TTS (Web Speech API)' });
			} catch (error) {
				statusEl.className = 'tts-status error';
				statusEl.innerHTML = '<span class="tts-icon">‚ùå</span><span>TTS initialization failed</span>';

				addLog('tts-error', { error: error.message });
			}
		}

		// Pass services to the player as JavaScript properties
		// NOTE: These CANNOT be set as HTML attributes - must be JavaScript properties
		player.ttsService = ttsService;
		player.toolCoordinator = toolCoordinator;
		player.highlightCoordinator = highlightCoordinator;

		// Event listeners
		player.addEventListener('section-loaded', (e) => {
			addLog('section-loaded', e.detail);
		});

		player.addEventListener('item-changed', (e) => {
			addLog('item-changed', e.detail);
		});

		player.addEventListener('session-changed', (e) => {
			addLog('session-changed', e.detail);
		});

		player.addEventListener('player-error', (e) => {
			addLog('player-error', e.detail);
		});

		function addLog(eventName, detail) {
			const entry = document.createElement('pre');
			entry.textContent = `[${new Date().toLocaleTimeString()}] ${eventName}: ${JSON.stringify(detail, null, 2)}`;
			log.insertBefore(entry, log.firstChild);
		}

		window.clearLog = () => {
			log.innerHTML = '';
		};

		window.testTTS = () => {
			// Test TTS by speaking sample text
			ttsService.speak(
				'This demonstrates how the section player integrates with the assessment toolkit TTS service. Services are passed as JavaScript properties through the component hierarchy.',
				{ language: 'en-US' }
			);
		};

		// Sample section data with catalog references
		const sectionData = {
			identifier: 'tts-demo-section',
			title: 'Reading Comprehension with TTS',
			keepTogether: false,

			rubricBlocks: [
				{
					id: 'passage',
					view: 'candidate',
					use: 'passage',
					passage: {
						id: 'passage-solar',
						name: 'The Solar System',
						baseId: 'passage-solar',
						version: { major: 1, minor: 0, patch: 0 },
						config: {
							markup: `<div id="p" class="passage" data-catalog-id="passage-solar-content" style="padding: 1.5rem; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 1rem;">
								<h2 style="margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem;">
									The Solar System
									<span style="font-size: 0.8rem; color: #999; margin-left: 1rem;">üì¢ TTS-enabled passage</span>
								</h2>
								<p>Our solar system consists of the Sun and everything that orbits around it, including eight planets, their moons, asteroids, comets, and other celestial objects.</p>
								<p>The Sun, a massive ball of hot gas, contains 99.8% of the solar system's mass and provides the energy that sustains life on Earth. The eight planets orbit the Sun in elliptical paths, with the inner planets (Mercury, Venus, Earth, and Mars) being rocky and terrestrial, while the outer planets (Jupiter, Saturn, Uranus, and Neptune) are gas giants.</p>
								<p>Each planet has unique characteristics that make it special, from Venus's thick atmosphere to Saturn's spectacular rings.</p>
								<p style="font-size: 0.9rem; color: #666; font-style: italic; margin-top: 1rem; padding: 0.5rem; background: #e3f2fd; border-left: 3px solid #2196f3;">
									Note: In a real implementation, the passage would have a TTS icon in the header that speakers can click to hear this content read aloud.
								</p>
							</div>`,
							elements: {},
							models: []
						}
					}
				}
			],

			assessmentItemRefs: [
				{
					identifier: 'q1',
					required: true,
					item: {
						id: 'item-001',
						name: 'Question 1',
						baseId: 'item-001',
						version: { major: 1, minor: 0, patch: 0 },
						config: {
							markup: `<div id="q1" data-catalog-id="item-001-content" style="padding: 1rem;">
								<p style="font-size: 1.1rem; margin-bottom: 1rem;">
									<strong>Question 1:</strong> What is at the center of our solar system?
									<span style="font-size: 0.8rem; color: #999; margin-left: 0.5rem;">üì¢ TTS-enabled</span>
								</p>
								<div style="margin-left: 1rem;">
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q1" value="sun" style="margin-right: 0.5rem;">
										A) The Sun
									</label>
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q1" value="earth" style="margin-right: 0.5rem;">
										B) The Earth
									</label>
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q1" value="moon" style="margin-right: 0.5rem;">
										C) The Moon
									</label>
								</div>
							</div>`,
							elements: {},
							models: []
						}
					}
				},
				{
					identifier: 'q2',
					required: true,
					item: {
						id: 'item-002',
						name: 'Question 2',
						baseId: 'item-002',
						version: { major: 1, minor: 0, patch: 0 },
						config: {
							markup: `<div id="q2" data-catalog-id="item-002-content" style="padding: 1rem;">
								<p style="font-size: 1.1rem; margin-bottom: 1rem;">
									<strong>Question 2:</strong> How many planets orbit the Sun?
									<span style="font-size: 0.8rem; color: #999; margin-left: 0.5rem;">üì¢ TTS-enabled</span>
								</p>
								<div style="margin-left: 1rem;">
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q2" value="seven" style="margin-right: 0.5rem;">
										A) Seven
									</label>
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q2" value="eight" style="margin-right: 0.5rem;">
										B) Eight
									</label>
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q2" value="nine" style="margin-right: 0.5rem;">
										C) Nine
									</label>
								</div>
							</div>`,
							elements: {},
							models: []
						}
					}
				},
				{
					identifier: 'q3',
					required: true,
					item: {
						id: 'item-003',
						name: 'Question 3',
						baseId: 'item-003',
						version: { major: 1, minor: 0, patch: 0 },
						config: {
							markup: `<div id="q3" data-catalog-id="item-003-content" style="padding: 1rem;">
								<p style="font-size: 1.1rem; margin-bottom: 1rem;">
									<strong>Question 3:</strong> What percentage of the solar system's mass does the Sun contain?
									<span style="font-size: 0.8rem; color: #999; margin-left: 0.5rem;">üì¢ TTS-enabled</span>
								</p>
								<div style="margin-left: 1rem;">
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q3" value="a" style="margin-right: 0.5rem;">
										A) 50%
									</label>
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q3" value="b" style="margin-right: 0.5rem;">
										B) 99.8%
									</label>
									<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
										<input type="radio" name="q3" value="c" style="margin-right: 0.5rem;">
										C) 75%
									</label>
								</div>
							</div>`,
							elements: {},
							models: []
						}
					}
				}
			]
		};

		window.loadPageMode = () => {
			player.section = {
				...sectionData,
				keepTogether: true
			};
			player.mode = 'gather';
			player.view = 'candidate';
			addLog('mode-changed', { mode: 'page', keepTogether: true });
		};

		window.loadItemMode = () => {
			player.section = {
				...sectionData,
				keepTogether: false
			};
			player.mode = 'gather';
			player.view = 'candidate';
			addLog('mode-changed', { mode: 'item', keepTogether: false });
		};

		// Initialize
		(async () => {
			await initializeTTS();
			loadItemMode();
		})();
	</script>
</body>
</html>
